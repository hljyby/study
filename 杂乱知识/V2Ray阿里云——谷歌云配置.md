谷歌云、阿里云配置 V2Ray 保持正确的冲浪姿势

发表于 2019-06-25 21:19

|

分类于 [印象笔记](https://www.lcgod.com/menu_22)

|

评论次数 17

|

阅读次数 37531

![https://img.lcgod.com/2019/06/25/1561467730.png](https://img.lcgod.com/2019/06/25/1561467730.png)



众所周知，正确的冲浪姿势是程序员的必备技能，之前我写过一篇 [vultr 配置 SSR 保持正确的冲浪姿势](https://www.lcgod.com/articles/91)，考虑到很多前端同学没有接触过服务器，或者刚入门的弟弟不懂命令行，所以写得非常之详细，我之所以还要再写一篇关于谷歌云和阿里云的配置教程有两个原因：

第一，大家都知道 vultr 是国外的主机商，官网都有可能被屏蔽，如果拿 vultr 和阿里云比，阿里云肯定更稳定，基本不可能被屏蔽，我司香港服务器的网站几年都很稳定，即使被屏蔽了你还可以进入阿里云的控制台，而且阿里云都是中文操作，对国人更加友好。但不得不说的是，大家选择 vultr 和搬瓦工等主机商最重要的原因是便宜，阿里云虽然稳定，但是缺点就是贵，所以用不用看个人经济能力。

第二，虽然谷歌云和 vultr 一样也是国外的，而且官网你都进不去，但是！谷歌云可以无限白嫖，1 分钱都不用花，这对于程序员来说才是真正的福报好吗？

![04ea1c699eff4990a7e7dd22fcb22f1f.gif](https://img.lcgod.com/2019/06/26/1561522112.gif)

嘻嘻，即使我们是社会主义的韭菜，我们也可以薅美利坚的羊毛，下面开始正文。

## 谷歌云新建 VM 实例

谷歌云官网必须得先科学上网才能进入，所以如果你没有梯子，那就只能先借一个，或者先购买阿里云的主机，搭好梯子，进入谷歌官网，搭好谷歌云的梯子后再把购买的阿里云的主机**无理由退货**就好了（感觉自己真是白嫖王，嘤嘤嘤）

需要注意的是，**我在写此文时，阿里云是支持 7 天无理由退货的，如果你没有梯子又想用上文的方法白嫖一波，一定要看清楚阿里云当下的政策是否支持退货**。

如何注册谷歌账号并绑定 **VISA信用卡** 我也不再赘述了，步骤非常简单，用户信息、国家地区等随便瞎选瞎填，只需要注意将 **VISA 信用卡** 的绑定信息填对就 OK。白嫖谷歌云必须得绑定一张 **VISA 信用卡**（国内的信用卡不行，一般在办理国内信用卡时都附带一张 VISA 卡）。

如果你没有 **VISA 信用卡** 只能看着大家白嫖。谷歌云现在的优惠策略是绑定完信用卡即送 300 刀，有 1 年的使用期限。如下图，我注册了一下新的谷歌云账号，并绑定了一张信用卡：

![QQ图片20190626102608.png](https://img.lcgod.com/2019/06/26/1561516001.png)

接着在右侧菜单中找到 VM 实例的入口，如下图：

![QQ图片20190626102908.png](https://img.lcgod.com/2019/06/26/1561516200.png)

然后在 VM 实例的页面中点击`创建实例`的按钮，进入如下页面：

![QQ图片20190626103335.png](https://img.lcgod.com/2019/06/26/1561516450.png)

如上，我标记的两处需要手动更改，第一个是区域，当然是选择**香港**或**台湾**，目前我用了两年谷歌云香港的主机，SSR 服务一次没有被墙过，极其稳定。

### 为什么你的服务老被墙？

说到稳定，很多同学就会问：为什么自己的服务老被墙？

被墙的原因太复杂了，举个最常见的例子就是当地运营商的问题，选择电信、联通、移动，被墙的概率都不太一样，例如北京地区的电信就不太稳定，有时候我在公司用的电信网，梯子貌似被墙了，回家之后用的联通网却能正常使用。

还有一些常见的原因，例如阿中哥正在举办一些重要会议，非常时期翻车概率也会大大增加、又或者你用的流量太大了，每天在 P 站看太多的小姐姐，自己营养跟不上就算了，还非常容易被墙识别出你的异常流量。

所以这个东西每个人情况都不太一样，非常看脸，如果你的服务被墙了，不要问太多为什么，直接重新搭一个，像我一样熟练的话 3 分钟就能搞定，也不碍事。

下面接着正文。

第二个就是防火墙要勾选 `允许 HTTP 流量`，以及 `允许HTTPS 流量`。

最后直接创建，会跳转至列表页，如下图：

![QQ图片20190626103818.png](https://img.lcgod.com/2019/06/26/1561516714.png)

接着，点击 SSH 按钮，使用谷歌的网页版 CLI 窗口，就可以对我们的主机系统进行一些操作。

虽然这个 网页版的 CLI 非常卡，但是也没办法，谷歌默认是不允许使用 ssh 进行远程密码登录的，所以我们必须要先从网页版的 CLI 窗口更改系统的 ssh 的登录设置，然后才能使用 XShell 等工具连接主机。

点击 SSH 按钮后，会弹出 CLI 窗口，如下图：

![QQ图片20190626104446.png](https://img.lcgod.com/2019/06/26/1561517096.png)

接着是命令行操作，依次执行如下几行命令，就可以更改 root 用户的登录密码以及允许 ssh 密码登录。

```nginx
# 切换为 root 用户
sudo -i

# 更改 root 用户的密码
passwd

# 允许 ssh 密码登录
sed -i 's/PermitRootLogin no/PermitRootLogin yes/g' /etc/ssh/sshd_config

sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config

sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config

# 重启 ssh 服务
service ssh restart
```

执行完以上命令，接着就可以在 XShell 中使用账号密码来连接主机啦。

如果无法连接，尝试手动修改 `/etc/ssh/sshd_config` 文件中的以下两个选项的值为 `yes`，`#` 开头代表该选项被注释掉了，记得要删除前面的 `#`。

```bash
PermitRootLogin yes
PasswordAuthentication yes
```

手动修改完毕后，保存并重新 ssh 服务。

## 阿里云新建 VM 实例

首先进入阿里云官网，找到购买主机的入口，进入购买主机的页面，如下图：

![QQ图片20190626112503.png](https://img.lcgod.com/2019/06/26/1561522355.png)

进入后，点击立即购买，进入如下页面：

![QQ图片20190626121514.png](https://img.lcgod.com/2019/06/26/1561522535.png)

如上图，我标记了 4 处，选择香港区域，1 核 1 G 配置，Debian 系统以及 20 G 系统盘，1个月费用是 42.15，跟其他主机商相比，是有点贵，但是我觉得还能接受。

点击下一步后，进入网络配置页面：

![QQ图片20190626131911.png](https://img.lcgod.com/2019/06/26/1561526416.png)

如上图，勾选 `分配公网 IPv4 地址`，并选择按流量付费，其他选项默认即可。

### 选择固定带宽还是按流量付费？

这里要说明一下，公网带宽计费分为两种：**固定带宽** 和 **按使用流量**。

第一种是按固定带宽付费，也就是说，比如你选择了 1 Mbps 固定带宽，那么下载速度上限就是 128 kb/s，一天最多能够花费 10 GB 左右流量，一个月流量上限就是 300 GB 左右，带宽费用是固定的 30 元。

第二种就是按流量付费，1 GB 流量是 1 元，而且带宽可以任意调整，如果设置为 100 Mbps 带宽，那么下载速度上限就是 12.5 MB/s，也就是说当我们选择按流量付费时，一个月的流量超过 30 GB，按流量付费就比固定带宽贵了。

对比两种方式，我们一般用来正常的科学上网，查资料、下载资料，1 个月也用不了 30 GB 流量，并且可以享受 100 Mbps 的网速，那肯定是选按流量付费。

如果你需要高强度逛 Youtube，看 4k 视频，那么建议你可以和我一样白嫖谷歌云的服务器，或者多出点钱，用阿里云的。

### 填写系统配置

最后一步，进入系统配置页面：

![QQ图片20190626131949.png](https://img.lcgod.com/2019/06/26/1561527531.png)

如上，选择自定义密码，然后自定义登录密码以及主机名称，最后完成支付，跳转至主机控制台，阿里云的主机就算配置完成了，如下图：

![QQ图片20190626134237.png](https://img.lcgod.com/2019/06/26/1561527763.png)

## 使用 Xshell 连接主机，并配置 V2Ray

如何下载 Xshell 并登录主机我就不再叙述，上篇 Vultr 配置 SSR 的文章我有详细介绍，不会的童鞋可以去那篇文章看看。

配置 V2Ray 的操作极其简单，感兴趣的童鞋去看看 [V2Ray官网](https://www.v2ray.com/)（需要科学上网）

### 下载安装 V2Ray

依次执行以下命令即可

```bash
wget https://install.direct/go.sh

chmod +x go.sh

./go.sh
```

执行成功后，会输出 `V2Ray v4.19.1 is installed.` 等字样。

### 修改 V2Ray 配置文件

V2Ray 的配置文件在 `/etc/v2ray/config.json`

输入以下命令编辑该文件

```bash
vi /etc/v2ray/config.json
```

然后连续按 `d` 键，将原本的文件内容清空，然后按 `i` 键开启编辑模式，复制以下配置

```js
{
  "log": {
    "access": "/var/log/v2ray/access.log",
    "error": "/var/log/v2ray/error.log",
    "loglevel": "warning"
  },
  "inbound": {
    "port": 7751,
    "protocol": "vmess",
    "settings": {
      "clients": [
        {
          "id": "392029fa-a9e0-42e3-93cb-97a9281495ed",
          "level": 1,
          "alterId": 100
        }
      ]
    },
    "streamSettings": {
      "network": "tcp"
    },
    "detour": {
      "to": "vmess-detour-118345"
    }
  },
  "outbound": {
    "protocol": "freedom",
    "settings": {}
  },
  "inboundDetour": [
    {
      "protocol": "vmess",
      "port": "10000-10010",
      "tag": "vmess-detour-118345",
      "settings": {},
      "allocate": {
        "strategy": "random",
        "concurrency": 5,
        "refresh": 5
      },
      "streamSettings": {
        "network": "kcp"
      }
    }
  ],
  "outboundDetour": [
    {
      "protocol": "blackhole",
      "settings": {},
      "tag": "blocked"
    }
  ],
  "routing": {
    "strategy": "rules",
    "settings": {
      "rules": [
        {
          "type": "field",
          "ip": [
            "0.0.0.0/8",
            "10.0.0.0/8",
            "100.64.0.0/10",
            "127.0.0.0/8",
            "169.254.0.0/16",
            "172.16.0.0/12",
            "192.0.0.0/24",
            "192.0.2.0/24",
            "192.168.0.0/16",
            "198.18.0.0/15",
            "198.51.100.0/24",
            "203.0.113.0/24",
            "::1/128",
            "fc00::/7",
            "fe80::/10"
          ],
          "outboundTag": "blocked"
        }
      ]
    }
  }
}
```

上面的配置中，`"port": 7751` 代表 服务器对外开放的端口是 `7751`，你可以修改为其他端口，也可以和我一样，这是自定义的。

复制完以上配置后，将其粘贴进编辑器，并输入命令 `wq`，保存并退出文件。

接着输入 `systemctl start v2ray` 启动 v2ray 进程，服务端的配置就完成了。

### 管理 V2Ray 进程的相关命令

```bash
# 查看 v2ray 进程状态
systemctl status v2ray

# 启动
systemctl start v2ray

# 重启
systemctl restart v2ray
```

### V2Ray 客户端

V2Ray 默认的客户端是一个 `CLI` 窗口，使用起来非常不方便，但是没关系，我们可以使用它的工具 [V2RayN](https://github.com/2dust/v2rayN/releases)

进入该网站后，下载下图中标记的 2 个压缩文件：

![QQ图片20190626140450.png](https://img.lcgod.com/2019/06/26/1561529156.png)

下载完成后，将其解压到同一个目录中：

![QQ图片20190626140704.png](https://img.lcgod.com/2019/06/26/1561529241.png)

然后运行 `v2rayN.exe`，点击 `服务器` -> `添加服务器`，打开如下页面：

![client_config.png](https://img.lcgod.com/2020/03/22/1584885086.png)

像图中一样分别设置好对应的参数，并确定即可完成客户端的配置，需要注意的是这些参数必须和上一步提到的 `config.json` 中对应的参数保持一致。

服务器地址：`你的主机 ip 地址`

端口：`config.json 文件中设置的端口（可以自定义填写，不一定需要使用我的配置）`

用户ID：`config.json 文件中设置的 clients.id（可以自己随机生成，不一定需要使用我的配置）`

额外ID：`config.json 文件中设置的 clients.alertId（可以自定义填写，不一定需要使用我的配置）`

选择加密方式：`auto`

传输协议：`tcp`

完成配置后，可以最小化窗口到桌面右下角任务栏，右击 v2RayN，即可选择开启或关闭代理服务：

![QQ图片20190626141648.png](https://img.lcgod.com/2019/06/26/1561529866.png)、

在需要进入墙外网站时，勾选启动，不需要进入的时候 取消勾选即可，非常方便。

## 防火墙设置

不要高兴的太早，配置完以上，基本不可能成功科学上网，因为还差最后一步，需要配置一下防火墙。

### 谷歌云防火墙设置

在谷歌控制台，打开右侧的菜单，找到防火墙规则的入口，进入该页面，如下图

![QQ图片20190626143751.png](https://img.lcgod.com/2019/06/26/1561534200.png)

然后点击创建防火墙规则按钮：

![QQ图片20190626143914.png](https://img.lcgod.com/2019/06/26/1561531160.png)

进入如下页面，然后根据我的标记，分别设置相应的参数，将 来源 IP 地址范围 设置为 `0.0.0.0/0`

![QQ图片20190626144249.png](https://img.lcgod.com/2019/06/26/1561534290.png)

因为前面 V2Ray 设置的协议是 `tcp`，端口是 `7751`，所以可以看到我在图中勾选的是 `tcp` 协议，端口设置为 `7751`，流量方向是`入站`，设置完之后点击`创建`按钮，即可大功告成。

### 阿里云防火墙设置

进入主机列表页面，点击 `更多` -> `网络和安全组` -> `安全组配置`，进入安全组列表页

![QQ图片20190626150411.png](https://img.lcgod.com/2019/06/26/1561534068.png)

然后点击右侧的 `配置规则`，跳转至规则列表页

![QQ图片20190626151036.png](https://img.lcgod.com/2019/06/26/1561533053.png)

在规则列表页点击右上角的 `添加安全组规则`

![QQ图片20190626150952.png](https://img.lcgod.com/2019/06/26/1561533132.png)

弹出如下窗口，和谷歌云的防火墙设置方式一样，因为前面 V2Ray 设置的协议是 `tcp`，端口是 `7751`，所以可以看到我在图中勾选的是 `tcp` 协议，端口设置为 `7751`，流量方向是`入站`，最后点击`确定`按钮。

![QQ图片20190626150725.png](https://img.lcgod.com/2019/06/26/1561533147.png)

接下来宁就可以愉快地进行网上冲浪啦。

![QQ图片20190626144756.png](https://img.lcgod.com/2019/06/26/1561531685.png)

## 配置 BBR 加速以及 SSR

依次运行以下命令即可开启 BBR 加速：

```bash
echo net.core.default_qdisc=fq >> /etc/sysctl.conf
echo net.ipv4.tcp_congestion_control=bbr >> /etc/sysctl.conf
sysctl -p
```

Debian 9 版本以上的系统自带 BBR，所以选择系统的时候最好选择 Debian 9+，这样我们就不需要自己再手动安装 BBR。

我在 [vultr 配置 SSR 保持正确的冲浪姿势](https://www.lcgod.com/articles/91) 这篇文章中有详细介绍如何在 CentOS 7 中配置 SSR 以及 BBR 加速，需要注意的是 **建议你在使用 V2ray 时 卸载 SSR 服务端**

SSR 和 V2Ray 二者只用一个即可，网上有很多测速，都说明 V2Ray 比 SSR 更快，并且更不容易被墙识别，所以我建议就用 V2Ray 好了，BBR 加速也是需要配置，不配置 BBR 和 配置 BBR 网速也有一定差距的。

你肯定想问既然 V2Ray 这么好，为什么还有人用 SSR？

其实 V2Ray 也有缺点，那就是配置稍微有点复杂，对于新手来说可能很不友好，以上。